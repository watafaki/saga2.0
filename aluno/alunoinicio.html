<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard | Aluno | Saga</title>
    <link rel="icon" type="image/png" href="../logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Novo Sistema de Design SAGA -->
    <link rel="stylesheet" href="../saga-design-system.css">
    <link rel="stylesheet" href="../saga-additional-styles.css">

    <style>
        /* Estilos específicos da página */
        .welcome-section {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border-radius: var(--radius-xl);
            padding: var(--space-xxl);
            margin-bottom: var(--space-xl);
            position: relative;
            overflow: hidden;
        }
        
        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .welcome-content {
            position: relative;
            z-index: 1;
        }
        
        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }
        
        .welcome-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: var(--space-lg);
        }
        
        .welcome-date {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .recent-activities {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .activity-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }
        
        .activity-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .activity-info h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-xs);
        }
        
        .activity-info p {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .activity-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-xs);
        }
        
        .activity-date {
            font-size: 0.75rem;
            color: var(--color-text-tertiary);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
        }
        
        .quick-action-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--color-text-primary);
        }
        
        .quick-action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }
        
        .quick-action-icon {
            width: 48px;
            height: 48px;
            background: var(--color-primary-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-md);
            color: var(--color-primary);
        }
        
        .quick-action-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }
        
        .quick-action-desc {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body class="saga-layout">
    <!-- O sistema de componentes criará automaticamente a sidebar e header -->
    
    <main class="saga-main">
        <div class="saga-content" style="padding: var(--space-xl);">
            <!-- Seção de Boas-vindas -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h1 class="welcome-title">Bem-vindo de volta!</h1>
                    <p class="welcome-subtitle">Aqui está o seu resumo acadêmico para hoje</p>
                    <div class="welcome-date" id="current-date"></div>
                </div>
            </section>

            <!-- Estatísticas do Dashboard -->
            <section class="dashboard-stats">
                <div class="saga-kpi-card">
                    <div class="saga-kpi-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                    </div>
                    <div class="saga-kpi-value" id="total-atividades">0</div>
                    <div class="saga-kpi-label">Atividades Pendentes</div>
                </div>

                <div class="saga-kpi-card">
                    <div class="saga-kpi-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    </div>
                    <div class="saga-kpi-value" id="atividades-hoje">0</div>
                    <div class="saga-kpi-label">Para Hoje</div>
                </div>

                <div class="saga-kpi-card">
                    <div class="saga-kpi-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <div class="saga-kpi-value" id="atividades-semana">0</div>
                    <div class="saga-kpi-label">Esta Semana</div>
                </div>

                <div class="saga-kpi-card">
                    <div class="saga-kpi-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                    </div>
                    <div class="saga-kpi-value" id="atividades-concluidas">0</div>
                    <div class="saga-kpi-label">Concluídas</div>
                </div>
            </section>

            <!-- Grid com Atividades Recentes e Ações Rápidas -->
            <div class="saga-grid cols-2" style="margin-bottom: var(--space-xl);">
                <!-- Atividades Recentes -->
                <section class="recent-activities">
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            Atividades Recentes
                        </h2>
                        <a href="alunoatvi.html" class="saga-button ghost small">
                            Ver todas
                        </a>
                    </div>
                    <div class="activity-list" id="recent-activities">
                        <!-- Atividades serão carregadas via JavaScript -->
                    </div>
                </section>

                <!-- Ações Rápidas -->
                <section>
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/>
                            </svg>
                            Acesso Rápido
                        </h2>
                    </div>
                    <div class="quick-actions">
                        <a href="alunoatvi.html" class="quick-action-card">
                            <div class="quick-action-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10,9 9,9 8,9"/>
                                </svg>
                            </div>
                            <div class="quick-action-title">Atividades</div>
                            <div class="quick-action-desc">Suas tarefas pendentes</div>
                        </a>

                        <a href="alunocrono.html" class="quick-action-card">
                            <div class="quick-action-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                            </div>
                            <div class="quick-action-title">Calendário</div>
                            <div class="quick-action-desc">Organize seu tempo</div>
                        </a>

                        <a href="alunocomu.html" class="quick-action-card">
                            <div class="quick-action-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="quick-action-title">Comunicados</div>
                            <div class="quick-action-desc">Novidades importantes</div>
                        </a>

                        <a href="alunonexus.html" class="quick-action-card">
                            <div class="quick-action-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/>
                                </svg>
                            </div>
                            <div class="quick-action-title">Nexus AI</div>
                            <div class="quick-action-desc">Assistente inteligente</div>
                        </a>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    
    <!-- Sistema de Componentes SAGA -->
    <script src="../saga-components.js"></script>

    <script>
        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDhHGoe7GDJhMOjYSTbgqC7DHE2Dc_RR0M",
            authDomain: "saga-1d4e2.firebaseapp.com",
            databaseURL: "https://saga-1d4e2-default-rtdb.firebaseio.com",
            projectId: "saga-1d4e2",
            storageBucket: "saga-1d4e2.firebasestorage.app",
            messagingSenderId: "419315470764",
            appId: "1:419315470764:web:4e3fd28ca21f935bc52a09",
            measurementId: "G-SSBL21VWE3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Dados mockados para demonstração
        const mockAtividades = [
            {
                id: 'mock-1',
                titulo: "Exercícios de Matemática",
                descricao: "Resolver os exercícios das páginas 45 a 50 do livro didático.",
                prazo: "2024-12-28",
                professor: "Prof. Silva",
                turma: "3º Ano A",
                concluida: false
            },
            {
                id: 'mock-2',
                titulo: "Redação sobre Literatura",
                descricao: "Escrever uma redação de 30 linhas sobre o Romantismo brasileiro.",
                prazo: "2024-12-30", 
                professor: "Prof. Maria",
                turma: "3º Ano A",
                concluida: false
            },
            {
                id: 'mock-3',
                titulo: "Projeto de Ciências",
                descricao: "Desenvolver um projeto sobre fontes de energia renovável.",
                prazo: "2025-01-05",
                professor: "Prof. João",
                turma: "3º Ano A",
                concluida: true
            }
        ];

        // Função principal para carregar dados do dashboard
        function loadDashboardData() {
            loadActivities();
            updateCurrentDate();
        }

        function loadActivities() {
            const currentUser = sagaComponents.currentUser;
            
            if (!currentUser) {
                processActivities(mockAtividades);
                return;
            }

            // Carregar atividades do Firebase
            db.ref('atividades').once('value')
                .then((snapshot) => {
                    const firebaseAtividades = snapshot.val();
                    let atividades = [];

                    if (firebaseAtividades) {
                        atividades = Object.keys(firebaseAtividades).map(key => ({
                            id: key,
                            ...firebaseAtividades[key],
                            professor: `Prof. ${firebaseAtividades[key].professorId?.substring(0, 8) || 'Desconhecido'}`,
                            concluida: false
                        }));
                    } else {
                        atividades = mockAtividades;
                    }

                    // Verificar atividades concluídas pelo usuário
                    if (currentUser) {
                        db.ref(`users/${currentUser.uid}/atividadesConcluidas`).once('value')
                            .then((snapshot) => {
                                const concluidas = snapshot.val() || {};
                                const idsConcluidas = Object.keys(concluidas);
                                
                                atividades.forEach(atividade => {
                                    if (idsConcluidas.includes(atividade.id)) {
                                        atividade.concluida = true;
                                    }
                                });
                                
                                processActivities(atividades);
                            })
                            .catch(() => processActivities(atividades));
                    } else {
                        processActivities(atividades);
                    }
                })
                .catch(() => processActivities(mockAtividades));
        }

        function processActivities(atividades) {
            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];
            const proximaSemana = new Date(hoje);
            proximaSemana.setDate(hoje.getDate() + 7);
            const proximaSemanaStr = proximaSemana.toISOString().split('T')[0];

            // Calcular estatísticas
            const atividadesPendentes = atividades.filter(a => !a.concluida);
            const atividadesHoje = atividadesPendentes.filter(a => a.prazo === hojeStr);
            const atividadesSemana = atividadesPendentes.filter(a => a.prazo <= proximaSemanaStr);
            const atividadesConcluidas = atividades.filter(a => a.concluida);

            // Atualizar KPIs
            updateElement('total-atividades', atividadesPendentes.length);
            updateElement('atividades-hoje', atividadesHoje.length);
            updateElement('atividades-semana', atividadesSemana.length);
            updateElement('atividades-concluidas', atividadesConcluidas.length);

            // Mostrar atividades recentes
            displayRecentActivities(atividadesPendentes.slice(0, 3));
        }

        function displayRecentActivities(atividades) {
            const container = document.getElementById('recent-activities');
            if (!container) return;

            container.innerHTML = '';

            if (atividades.length === 0) {
                container.innerHTML = `
                    <div class="saga-empty-state">
                        <div class="saga-empty-state-icon">🎉</div>
                        <div class="saga-empty-state-title">Parabéns!</div>
                        <div class="saga-empty-state-description">Não há atividades pendentes no momento.</div>
                    </div>
                `;
                return;
            }

            atividades.forEach(atividade => {
                const status = getActivityStatus(atividade.prazo);
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card';
                
                activityCard.innerHTML = `
                    <div class="activity-info">
                        <h4>${atividade.titulo}</h4>
                        <p>${atividade.professor} • ${atividade.turma || 'Turma'}</p>
                    </div>
                    <div class="activity-meta">
                        <div class="activity-date">${formatDate(atividade.prazo)}</div>
                        <div class="saga-badge ${status.class}">${status.text}</div>
                        ${!atividade.concluida ? `
                            <button class="saga-button small primary" onclick="markAsCompleted('${atividade.id}')" title="Marcar como concluída">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(activityCard);
            });
        }

        function getActivityStatus(prazo) {
            const hoje = new Date();
            const dataPrazo = new Date(prazo);
            const diffTime = dataPrazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { class: 'error', text: 'Atrasada' };
            } else if (diffDays === 0) {
                return { class: 'warning', text: 'Hoje' };
            } else if (diffDays <= 3) {
                return { class: 'warning', text: 'Em breve' };
            } else {
                return { class: 'neutral', text: 'Pendente' };
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function updateCurrentDate() {
            const agora = new Date();
            const dataFormatada = agora.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            updateElement('current-date', dataFormatada);
        }

        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = content;
            }
        }

        function markAsCompleted(atividadeId) {
            const currentUser = sagaComponents.currentUser;
            
            if (!currentUser) {
                sagaComponents.showToast('Você precisa estar logado para marcar atividades como concluídas', 'warning');
                return;
            }

            if (atividadeId.startsWith('mock-')) {
                sagaComponents.showToast('Atividade marcada como concluída!', 'success');
                loadActivities();
                return;
            }

            // Salvar no Firebase
            db.ref(`users/${currentUser.uid}/atividadesConcluidas/${atividadeId}`).set({
                concluida: true,
                dataConclusao: firebase.database.ServerValue.TIMESTAMP,
                atividadeId: atividadeId
            })
            .then(() => {
                sagaComponents.showToast('Atividade marcada como concluída!', 'success');
                loadActivities();
            })
            .catch((error) => {
                console.error('Erro ao marcar atividade como concluída:', error);
                sagaComponents.showToast('Erro ao marcar atividade como concluída', 'error');
            });
        }

        // Inicialização quando o usuário estiver autenticado
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadDashboardData();
            } else {
                window.location.href = '../login.html';
            }
        });

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', () => {
            // O sistema de componentes já será inicializado automaticamente
            loadDashboardData();
        });
    </script>
</body>
</html>